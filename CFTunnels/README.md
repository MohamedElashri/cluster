### Documentation: Setting Up Cloudflare Tunnel on Proxmox for Remote Access

This documentation provides detailed steps to set up a Cloudflare Tunnel on your Proxmox server, allowing you to securely access your services over the internet, even if your internet connection does not support static IPs or port forwarding. This guide also covers how to make the tunnel resilient to reboots and internet disconnections.

---

### Table of Contents

1. [Prerequisites](#prerequisites)
2. [Step 1: Install Cloudflared on Proxmox](#step-1-install-cloudflared-on-proxmox)
3. [Step 2: Authenticate Cloudflared with Cloudflare](#step-2-authenticate-cloudflared-with-cloudflare)
4. [Step 3: Create and Configure the Tunnel](#step-3-create-and-configure-the-tunnel)
5. [Step 4: Create DNS Records in Cloudflare](#step-4-create-dns-records-in-cloudflare)
6. [Step 5: Run Cloudflared as a Systemd Service](#step-5-run-cloudflared-as-a-systemd-service)
7. [Step 6: Verify the Setup](#step-6-verify-the-setup)
8. [Additional Considerations](#additional-considerations)
9. [Troubleshooting](#troubleshooting)

---

### Prerequisites

- **Proxmox server**: Installed and configured.
- **Cloudflare account**: Active account with a domain added to Cloudflare.
- **Root access**: SSH access to your Proxmox server with root or sudo privileges.

---

### Step 1: Install Cloudflared on Proxmox

1. **SSH into your Proxmox server**:
   ```bash
   ssh root@your-proxmox-ip
   ```

2. **Download and install Cloudflared**:
   ```bash
   wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
   sudo dpkg -i cloudflared-linux-amd64.deb
   ```

---

### Step 2: Authenticate Cloudflared with Cloudflare

1. **Log in to Cloudflare**:
   ```bash
   cloudflared tunnel login
   ```
   - A link will be provided in the terminal.
   - Copy and paste this link into your web browser to authenticate.

2. **Create a new tunnel**:
   ```bash
   cloudflared tunnel create proxmox-tunnel
   ```
   - Note the UUID generated by this command. You will use it in later steps.

---

### Step 3: Create and Configure the Tunnel

1. **Create a configuration file**:
   ```bash
   sudo nano /root/.cloudflared/config.yml
   ```

2. **Add the following content to the `config.yml` file**:
   ```yaml
   tunnel: <UUID>
   credentials-file: /root/.cloudflared/<UUID>.json

   ingress:
     - hostname: proxmox.yourdomain.com
       service: https://localhost:8006
       originRequest:
         disableChunkedEncoding: true
         noTLSVerify: true
     - service: http_status:404
   ```
   - Replace `<UUID>` with the UUID generated earlier.
   - Replace `proxmox.yourdomain.com` with your desired subdomain.

3. **Save and exit** the file (Ctrl + O, Enter, Ctrl + X).

---

### Step 4: Create DNS Records in Cloudflare

1. **Route the subdomain to your tunnel**:
   ```bash
   cloudflared tunnel route dns <UUID> proxmox.yourdomain.com
   ```
   - Replace `<UUID>` with your tunnel UUID.
   - Replace `proxmox.yourdomain.com` with your subdomain.

---

### Step 5: Run Cloudflared as a Systemd Service

To ensure the tunnel is resilient to reboots and network disruptions, you can configure Cloudflared to run as a systemd service.

1. **Create a systemd service file**:
   ```bash
   sudo nano /etc/systemd/system/cloudflared.service
   ```

2. **Add the following content** to the service file:
   ```ini
   [Unit]
   Description=Cloudflare Tunnel for Proxmox
   After=network.target

   [Service]
   Type=simple
   ExecStart=/usr/local/bin/cloudflared tunnel run <UUID>
   Restart=on-failure
   RestartSec=5s
   User=root
   WorkingDirectory=/root/.cloudflared

   [Install]
   WantedBy=multi-user.target
   ```
**hint**. Don't forget to change `<UUID>` in this file.

3. **Reload systemd** to recognize the new service:
   ```bash
   sudo systemctl daemon-reload
   ```

4. **Enable the service to start at boot**:
   ```bash
   sudo systemctl enable cloudflared.service
   ```

5. **Start the service**:
   ```bash
   sudo systemctl start cloudflared.service
   ```

---

### Step 6: Verify the Setup

1. **Check the status of the service**:
   ```bash
   sudo systemctl status cloudflared.service
   ```
   - Ensure the service is active and running.

2. **Access Proxmox** via the Cloudflare Tunnel:
   - Open your web browser and navigate to `https://proxmox.yourdomain.com`.
   - You should be able to access the Proxmox admin interface securely.

---

### Additional Considerations

- **Adding More Services**: You can add additional services by modifying the `config.yml` file and creating new subdomains in Cloudflare.
- **Security**: Consider implementing Cloudflare Access to restrict access to your Proxmox admin interface and other services.
- **Monitoring**: Use `journalctl -u cloudflared.service` to view logs and monitor the service.

---

### Troubleshooting

- **Service Not Starting**: Ensure that the UUID in the `config.yml` matches the tunnel UUID and that the DNS entry is correctly pointing to the tunnel.
- **Connection Drops**: Verify that the `Restart=on-failure` directive is present in the systemd service file to handle network disruptions.
- **NoTLSVerify Issues**: If you encounter issues related to SSL, confirm that `noTLSVerify: true` is correctly set for services using self-signed certificates.

---

By following these steps, you can securely access your Proxmox server and other services via Cloudflare Tunnel, ensuring reliable and persistent remote access even in challenging network conditions.
